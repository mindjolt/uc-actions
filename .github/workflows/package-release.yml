name: 'Package Release'

on:
  workflow_call:
    inputs:
      sdk_name:
        type: string
        required: true
      branch:
        type: string
        required: true
      version:
        type: string
        required: true
      slack_channel:
        type: string
        required: true
      dry_run:
        type: boolean
        required: true

jobs:
  build-and-release-package:
    name: 'Build and Release Package'
    runs-on: ['self-hosted', 'macOS', 'unity', 'unity-core']
    defaults:
      run:
        shell: bash

    env:
      PROJECT_NAME: 'UnityCore.${{ github.event.inputs.sdk_name }}'
      PACKAGE_NAME: 'JamCity.UnityCore.${{ github.event.inputs.sdk_name }}'
      PROJECT_PATH: 'Assets/Plugins/JamCity/JamCity.UnityCore.${{ github.event.inputs.sdk_name }}'
      RELEASE_PATH: 'Assets/Plugins/JamCity/JamCity.UnityCore.${{ github.event.inputs.sdk_name }}/Editor/Release'

    steps:
      - name: Cloning ${{ github.ref }}
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: 'Update change log'
        uses: mindjolt/uc-actions/update-changelog@main
        with:
          version: ${{ github.event.inputs.version }}

      - name: 'Create package'
        working-directory: ${{ env.RELEASE_PATH }}
        run: ./gradlew createPackage
        env:
          PACKAGE_VERSION: ${{ github.event.inputs.version }}

      - name: 'Rename zip artifact'
        working-directory: ${{ env.RELEASE_PATH }}/build/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}
        run: mv package.zip ${{ env.PACKAGE_NAME }}.zip

      - name: 'Update package artifacts'
        run: |
          cp ${{ env.RELEASE_PATH }}/build/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}/package.json ${{ env.PROJECT_PATH }}/package.json
          unzip -o -j -d ${{ env.PROJECT_PATH }} ${{ env.RELEASE_PATH }}/build/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}.zip ${{ env.PACKAGE_NAME }}/JamCityBuildInfo.cs

      - name: 'Commit changes'
        run: |
          git add CHANGELOG.md ${{ env.PROJECT_PATH }}/package.json ${{ env.PROJECT_PATH }}/JamCityBuildInfo.cs
          git commit -m "Files updated for ${{ env.PROJECT_NAME }} ${{ github.event.inputs.version }} release."

      - name: 'Push changes to GitHub'
        if: ${{ github.event.inputs.dry_run == 'false' }}
        run: git push

      - name: 'Publish release on GitHub'
        if: ${{ github.event.inputs.dry_run == 'false' }}
        uses: mindjolt/uc-actions/publish-release@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ github.event.inputs.version }}
          ref: ${{ github.event.inputs.branch }}

      - name: 'Publish to Artifactory'
        if: ${{ github.event.inputs.dry_run == 'false' }}
        uses: mindjolt/actions/package-manager-publish@v2
        with:
          rootUrl: ${{ secrets.ARTIFACTORY_ROOT }}
          user: ${{ secrets.ARTIFACTORY_USER }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}
          packageZip: ${{ env.RELEASE_PATH }}/build/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}.zip
          packageJson: ${{ env.RELEASE_PATH }}/build/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}/package.json
          branchRef: ${{ github.ref }}

      - name: 'Post to Slack'
        if: ${{ github.event.inputs.dry_run == 'false' }}
        uses: mindjolt/uc-actions/post-to-slack@main
        with:
          token: ${{ secrets.SLACK_TOKEN }}
          channel: ${{ github.event.inputs.slack_channel }}
          project_name: ${{ env.PROJECT_NAME }}
          version: ${{ github.event.inputs.version }}

      - name: 'Upload Artifacts'
        uses: actions/upload-artifact@v2
        with:
          path: |
            Editor/Release/build/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}.zip
            Editor/Release/build/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_NAME }}/package.json
